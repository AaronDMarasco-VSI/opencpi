\iffalse
This file is protected by Copyright. Please refer to the COPYRIGHT file
distributed with this source distribution.

This file is part of OpenCPI <http://www.opencpi.org>

OpenCPI is free software: you can redistribute it and/or modify it under the
terms of the GNU Lesser General Public License as published by the Free Software
Foundation, either version 3 of the License, or (at your option) any later
version.

OpenCPI is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License along
with this program. If not, see <http://www.gnu.org/licenses/>.
\fi

%----------------------------------------------------------------------------------------
% Update the docTitle and docVersion per document
%----------------------------------------------------------------------------------------
\def\docTitle{ZedBoard Getting Started Guide}
\def\docVersion{1.2}
%----------------------------------------------------------------------------------------
\input{snippets/LaTeX_Header.tex}
\date{Version \docVersion} % Force date to be blank and override date with version
\title{\docTitle}
\lhead{Zedboard Getting Started Guide}
%----------------------------------------------------------------------------------------
\usepackage[T1]{fontenc} % http://tex.stackexchange.com/a/181119
\usepackage{graphicx}
\graphicspath{ {figures/} }
\begin{document}
\maketitle
%\thispagestyle{fancy}
\newpage

	\begin{center}
	\textit{\textbf{Revision History}}
		\begin{table}[H]
		\label{table:revisions} % Add "[H]" to force placement of table
			\begin{tabularx}{\textwidth}{|c|X|l|}
			\hline
			\rowcolor{blue}
			\textbf{Revision} & \textbf{Description of Change} & \textbf{Date} \\
		    \hline
		    v1.1 & Initial Release & 3/2017 \\
            \hline
            v1.2 & Updated for ANGRYVIPER Release 1.2 & 8/2017 \\
            \hline
			\end{tabularx}
		\end{table}
	\end{center}

\newpage

\tableofcontents

\newpage

\section{References}
	This document assumes a basic understanding of the Linux command line (or ``shell'') environment.  The reference(s) in Table 1 can be used as an overview of ANGRYVIPER and may prove useful.
\def\refskipocpiov{}
\def\refcapbottom{}
\input{snippets/References_Table}

\newpage
\section{Overview}
This purpose of this document is to allow the user to install ANGRYVIPER on the ZedBoard Development Board.
\section{Prerequisites}
\begin{flushleft}
This guide assumes that the following RPMs are installed:  \\
\begin{table}[H]

		\label{table:rpms}
			\begin{tabularx}{\textwidth}{|c|X|}
			\hline
			\rowcolor{blue}
			\textbf{RPM Name} & \textbf{Description} \\
			\hline
			All prerequsite RPMs & These packages have ANGRYVIPER-specific patches and are provided as RPMs. This packaging ensures they will not conflict with other installed copies by using a nonstandard installation location of \path{/opt/opencpi/prerequisites}. \\
		    \hline
		    angryviper-1.2.0-*.el7.centos.x86\_64 & Base installation RPM includes the runtime portion of the Component Development Kit (CDK), scripts for creating the user's workspace, and limited documentation. \\
		    \hline
		    angryviper-devel-*.el7.centos.x86\_64 & Additional header files and scripts for developing new assets as HDL and/or RCC. \\
		    \hline
		    angryviper-sw-platform-xilinx13\_3-*.el7.centos.noarch & Additional files necessary to build the framework targeting the xilinx13\_3 software platform. \\
		    \hline
		    angryviper-hw-platform-zed-*.el7.centos.noarch & Additional files necessary to build the framework targeting specific hardware platforms. Automatically requires the zed sw-platform package. \\
		    \hline
			\end{tabularx}
\end{table}
This guide assumes that the Core and Assets projects have user copies and have been registered. Creating user copies of projects is done by using the new\_projet\_source script as described in the Getting Started Guide.  registering projects is done by running the command \code{ocpidev register project} at the top level of the project.   \\ \bigskip

The development board that is expected to be used is Digilent's ZedBoard. ANGRYVIPER has been tested on ZedBoard Rev. C and Rev. D. Each has separate limitations (described in Myriad-RF\_1\_Zipper\_Limitations.pdf). An Ethernet cable will need to be be plugged in to the Ethernet port on the board.  The ZedBoard gets an IP Address by using DHCP.  It is a requirement if operating in network mode (discussed later) that the Ethernet cable is connected to a network that uses DHCP. \\ \bigskip

There is a micro-USB serial port on the back of the ZedBoard labeled UART. A Male micro-USB cable will need to be plugged into this port to access the serial connection.
\begin{figure}[ht]
	\centerline{\includegraphics[scale=0.05]{zed_ether}}
	\caption{Connected Ethernet}
	\label{fig:zed_ether}
\end{figure}
\begin{figure}[ht]
	\centerline{\includegraphics[scale=0.05]{zed_uart}}
	\caption{Connected Serial USB}
	\label{fig:zed_uart}
\end{figure}

\newpage
On one side of the development board, there is a FMC LPC slot. Optionally, this can be used to connect plug-in modules. ANGRYVIPER has been tested with Lime Microsystems' Zipper card with the MyriadRF-1, Analog devices FMCOMMS2, and Analog devices FMCOMMS3 connected to the ZedBoard.\\   \bigskip

Below the FMC LPC slot (underneath the board), is the SD card slot you will be using throughout this guide.
\begin{figure}[ht]
	\centerline{\includegraphics[scale=0.05]{zed_fmc_sd}}
	\caption{ZedBoard FMC Slot and SD card Slot}
	\label{fig:zed_fmc_sd}
\end{figure}
\begin{figure}[ht]
	\centerline{\includegraphics[scale=0.05]{zed_zipper}}
	\caption{ZedBoard With Zipper and MyriadRF-1 Connected to the FMC Slot}
	\label{fig:zed_zipper}
\end{figure}
\end{flushleft}

\section{Script Setup}
There are two modes for running applications on any embedded radio or development board: network mode and standalone mode.  Network mode is when the development system hosts the ANGRYVIPER tree as an NFS server to the ZedBoard as an NFS client.  This configuration provides easy and dynamic access to all of ANGRYVIPER, and presumably any components and applications.  Standalone mode is when all the artifacts are located on the board's local storage (\textit{e.g.} SD card) and no network connection is required.  This is a better \textit{deployment} mode, and is better for situations where a network connection is not possible or practical.  Network mode is generally preferred when it is possible because it makes the development process easier than standalone mode.

\begin{flushleft}
For each mode, there are separate startup scripts that are run on the board. These scripts will need to be modified for each user's specific setup and file structure.  There are starting points for these scripts that are provided by the framework.  For networked mode the script is located at \path{/opt/opencpi/boot_support/zed/OpenCPI-SD-zed/opencpi/default_mynetsetup.sh}.  For standalone mode, the script is located at \path{/opt/opencpi/boot_support/OpenCPI-SD-zed/opencpi/default_mysetup.sh}.  These scripts need to be renamed to \texttt{mynetsetup.sh} and \texttt{mysetup.sh} before they are copied over to the SD card in Section \ref{sec:HW_Setup}. \\ \bigskip

\textit{For either usage mode}, the following settings that are passed by \texttt{mynetsetup.sh/mysetup.sh} to the \texttt{zynq\_net\_setup.sh/zynq\_setup.sh} scripts \textit{might} need to be modified:
\end{flushleft}

\begin{itemize}
 \item The system to be used as a time server. Defaulted to ``time.nist.gov''. Change this if you have a local time sever that supports RFC-868.
 \item The current timezone description. Defaulted to ``EST5EDT,M3.2.0,M11.1.0''.  Change this if required for the local timezone. See \texttt{man tzset} on the host PC for more information.
 \item If you do not have a time server, or cannot connect to a time server, you will need to manually set the time at start up.  Use the date command to manually set the Linux system time. See \texttt{man date} on the host PC for more information.  If Linux system time is not required to be accurate, you can skip this step.
 \end{itemize}

\begin{flushleft}
\textit{When using Network Mode}, the following modifications are required:
\end{flushleft}

\begin{enumerate}
\item In \texttt{mynetsetup.sh}, find the following lines which are necessary for mounting Assets Project and the Core Project:
\begin{verbatim}
mkdir -p /mnt/ocpi_core
mount -t nfs -o udp,nolock,soft,intr $1:/home/user/ocpiCore /mnt/ocpi_core
mkdir -p /mnt/ocpi_assets
mount -t nfs -o udp,nolock,soft,intr $1:/home/user/ocpiAssets /mnt/ocpi_assets
\end{verbatim}
 \item Edit \texttt{/home/user/ocpiCore} and \texttt{/home/user/ocpiAssets} to reflect the paths to the Core Project and Assets Project on the host. \\
\end{enumerate}

\label{sec:buildNow}
\textit{For Standalone Mode}, all ANGRYVIPER artifacts required to run any applications on the ZedBoard need to be copied onto the SD card.  So, you must build these artifacts earlier when operating in Standalone Mode. Perform the steps in Section \ref{sec:buildverify}  now. The artifacts created will be copied over to the SD card in Section \ref{sec:HW_Setup}. In general, you will want to copy any required \texttt{.so} (RCC workers), \texttt{.bit.gz} (hdl assemblies), and application XMLs or executables onto the SD card.

\subsection{Multiple ZedBoards on the same network}
If you plan to have multiple ZedBoards on one network, you will need to make a change to the zynq startup scripts. This is necessary because by default the ZedBoards will all have the same MAC address. To resolve this, uncomment the following lines in the zynq\_net\_setup.sh and zynq\_setup.sh scripts:
\begin{verbatim}
  # ifconfig eth0 down
  # ifconfig eth0 hw ether 00:0a:35:00:01:23
  # ifconfig eth0 up
  # udhcpc
\end{verbatim}
\section{Hardware and SD Card Setup}
\label{sec:HW_Setup}
\subsection*{Make a backup image of SD card (assumes Linux host)}
This optional section provides the steps for creating an SD card backup image. The following sections assume the SD card is empty.
\begin{itemize}
\item Determine the device file name for the SD card. It will likely be something like \texttt{/dev/sdb} or \texttt{/dev/mmcblk0}. To do this, you can take a look at the end of dmesg: ``\texttt{dmesg | tail -n 15}''.
\item Run the command ``\texttt{dd if=DEVICENAME of=backup.image}'' where DEVICENAME was determined above. This step should take $\sim15$ minutes depending on the card size.
\end{itemize}
\noindent To restore the card back to the original contents, run the command ``\texttt{dd of=DEVICENAME if=backup.image}'' (Do not do this step unless you want the original contents back on the SD card.)
\subsection*{Formatting and populating the SD card}
\begin{itemize}
\item Format the SD card with a single FAT32 partition.
\item Copy the all of the contents of \texttt{/opt/opencpi/boot\_support/OpenCPI-SD-zed/} to this partition.
\end{itemize}
\subsubsection*{Copy the files needed for Standalone Mode to SD card}
\textit{For Standalone Mode}:
\begin{itemize}
\begin{minipage}{\linewidth}
 \item Copy the following files into the \texttt{opencpi/xml} directory on this partition:
 \begin{itemize}
   \item \path{<Assets_Project>/applications/bias.xml}
   \item \path{<Assets_Project>/applications/test.input}
 \end{itemize}
 \item Copy the following files into the \texttt{opencpi/artifacts} directory on this partition:
 \begin{itemize}
   \item \path{<Assets_Project>/hdl/assemblies/testbias/container-testbias_zed_base/target-zynq/testbias_zed_base.bit.gz}
 \end{itemize}
\end{minipage}
\end{itemize}

\newpage
\begin{flushleft}
The SD card file structure should be as follows when these steps have been completed (ellipsis used to denote repetitive files):
\end{flushleft}
\begin{verbatim}
+-- boot.bin
+-- devicetree.dtb
+-- opencpi
|   +-- artifacts
|   |   +-- 001-bias_cc_s.so
       ...
|   |   +-- 020-testzc_s.so
|   |   \-- testbias_zed_base.bit.gz # only in Standalone Mode
|   +-- bin
|   |   +-- ocpibootstrap.sh
|   |   +-- ocpidriver
|   |   +-- ocpihdl
|   |   +-- ocpi_linux_driver
|   |   +-- ocpirun
|   |   +-- ocpiserve
|   |   +-- ocpixml
|   |   \-- ocpizynq
|   +-- default_mynetsetup.sh
|   +-- default_mysetup.sh
|   +-- lib
|   |   \-- linux-x13_3-arm
|   |       +-- libocpi_application_s.so
           ...
|   |       +-- libocpi_util_s.so
|   |       +-- mdev-opencpi.rules
|   |       \-- opencpi-3.10.0-xilinx-dirty-v14.7.ko
|   +-- mynetsetup.sh
|   +-- mysetup.sh
|   +-- system.xml
|   +-- xml
|   |   +-- bias.xml
       ...
|   |   +-- testbias.xml
|   |   +-- test.input # only in Standalone Mode
|   |   \-- time_test.xml
|   +-- zynq_net_setup.sh
|   \-- zynq_setup.sh
+-- uImage
\-- uramdisk.image.gz

\end{verbatim}

\subsection*{Serial setup}
By default, the USB to serial adapter will connect as read-only unless \texttt{udev} rules are added to have the device connect as read write.  Copy the file from the rpm install \path{/opt/opencpi/boot_support/zed/udev.rules/98-zedboard.rules} to \path{/etc/udev/rules.d/}.  This will cause the USB to Serial adapter to connect as \texttt{/dev/zed0} with read and write permissions for all users.  To connect to the serial port, use the command ``\texttt{screen /dev/zed0 115200}''.
\subsection*{Boot the ZedBoard from the SD card}
\begin{enumerate}
\item Remove power from the ZedBoard unit.
\item Ensure jumpers are configured correctly
\subitem To boot from the SD card, jumpers J10, J9, and J8 need to be set to 1, 1, and 0 respectively.
\begin{figure}[ht]
	\centerline{\includegraphics[scale=0.15]{zed_top}}
	\caption{Top View of the ZedBoard with J10, J9, J8 Set}
	\label{fig:zed_top}
\end{figure}
\item Insert the SD card into the SD card slot.
\item Connect a terminal to the micro-USB UART connector of the ZedBoard with a baud rate of 115200.
\begin{itemize}
\item per the previous section, ``\texttt{screen /dev/zed0 115200}'' can be used to connect to the serial port.
\end{itemize}
\item Apply power to the ZedBoard with the terminal still connected.
\end{enumerate}

\section{Software Setup}
% Bring in NFS setup snippet (has subsections)
\input{snippets/NFS_Setup_Snippet.tex}
%

\subsubsection*{Power cycle the ZedBoard}
Make sure the USB cable is plugged into the UART micro-USB port. The ZedBoard should now boot a valid ANGRYVIPER environment.  The user name and password for the development board are both ``root''.  A successful boot up screen will look as follows:

\begin{figure}[H]
	\centerline{\includegraphics[scale=0.5]{zed_boot}}
	\caption{Successful Boot}
	\label{fig:boot1}
\end{figure}
\subsubsection*{Using the ZedBoard in Network Mode}
\begin{flushleft}
Every time the development board is rebooted, the user is required to run the \texttt{mynetsetup.sh}, which configures the system for ANGRYVIPER with support for network/NFS mode\footnote{This script calls the \texttt{zynq\_net\_setup.sh} script, which is not user-modifiable.}. The user passes the network address of the development system in as the only argument to \texttt{mynetsetup.sh}.
\end{flushleft}
\begin{flushleft}
\newpage
After the development board is booted, the first thing that needs to be done is to source the \texttt{mynetsetup.sh} script with\\
\leavevmode{\parindent=3em\indent}\code{. /mnt/card/mynetsetup.sh XX.XX.XX.XX}\\
and changing XX.XX.XX.XX to the IP address of the NFS host (your development machine, \textit{e.g.} 192.168.1.10). A successful run is shown in Figure~\ref{fig:netsetup}.
\end{flushleft}
\begin{figure}[H]
	\centerline{\includegraphics[scale=0.5]{zed_net_setup}}
	\caption{Successful Network Mode Setup}
	\label{fig:netsetup}
\end{figure}
\newpage
\subsection{Standalone Mode}
All artifacts for any applications or tests that need to be located on the SD card must be in the \texttt{opencpi/artifacts} folder.  All of the helper utilities such as \texttt{ocpirun} and \texttt{ocpihdl} are already located on the SD card and do not need to be copied over to the ZedBoard platform.

\subsubsection*{Power cycle the ZedBoard}
The ZedBoard should now boot a valid ANGRYVIPER environment.  The user name and password for the development board are both ``root''.  A successful boot up screen will look as follows:
\begin{figure}[H]
	\centerline{\includegraphics[scale=0.5]{zed_boot}}
	\caption{Successful Boot}
	\label{fig:boot2}
\end{figure}
\newpage
\subsubsection*{Using the ZedBoard in Standalone Mode}
\begin{flushleft}
Every time the development board is rebooted, the user is required to run the \texttt{mysetup.sh}, which configures the system for ANGRYVIPER\footnote{This script calls the \texttt{zynq\_setup.sh} script, which is not user-modifiable.}. Any time that a new version of ANGRYVIPER is released, the SD card will need to be recreated in order to update the artifacts and the executables that are stored on the SD card.
\end{flushleft}
\begin{flushleft}
After the development board is booted, the first thing that needs to be done is to source the \texttt{mysetup.sh} script with\\
\leavevmode{\parindent=3em\indent}\code{. /root/opencpi/mysetup.sh}\\
A successful run of this will be as follows:
\end{flushleft}


\begin{figure}[H]
	\centerline{\includegraphics[scale=0.5]{zed_setup}}
	\caption{Successful Standalone Mode Setup}
	\label{fig:standalonesetup}
\end{figure}

\section{Verification}
The installation can be verified by running an application that uses both RCC and HDL workers.  There is an application that uses two RCC and one HDL worker located in \texttt{<Assets Project>/applications/bias.xml}. The two RCC workers are provided pre-built on the SD card or mounted CDK directory.  The HDL worker needs to be built into an assembly before the application can be executed.
\subsection{Building}
\label{sec:buildverify}
If operating in Standalone Mode, these steps should have been performed earlier. (See \ref{sec:buildNow}.)
\\ \\
First the Core project needs to be built for the zed platform.  This is performed at the top level of the Core project running the command \code{ ocpidev build -\--hdl-platforms zed}.  This will take about 45 minutes to complete.
\\ \\
Then the Zed platform needs to be built this is located in the Assets project.  To build this at the top level of the Assets project run the command \code{ocpidev build hdl platform zed}.  This will take about 45 minutes to complete.
\\ \\
There is an existing assembly in the assets project that is the bias worker with its inputs and outputs connected to software.  This assembly needs to be built for ``zed'' platform. It is located in \path{<Assets_Project>/hdl/assemblies/testbias/}.  At the top level of the project run the following command: ``\texttt{ocpidev build hdl assembly testbias -\--hdl-platform zed}''.  This should take about 15 minutes to complete. You can confirm that it succeeded by locating the \texttt{*.bit.gz} file in \path{container-testbias_zed_base/target-zed/}.\\
\newpage
\subsection{Running Network Mode}
The default setup script should already set the \texttt{OCPI\_LIBRARY\_PATH} variable to point to the RCC workers that are required to execute the application, but it needs to be updated to point to the assembly that was built.  After running the \texttt{mynetsetup.sh} script, navigate to  \texttt{/mnt/ocpi\_coreproject/applications}. Update the \texttt{OCPI\_LIBRARY\_PATH} variable using the following command: \\ ``\texttt{export OCPI\_LIBRARY\_PATH=\$OCPI\_LIBRARY\_PATH:/mnt/ocpi\_coreproject/hdl/assemblies/}''
In order to run the application, use the following command: ``\texttt{ocpirun -v -t 1 -d -m bias=hdl bias.xml}'' The output should be as follows:
\begin{figure}[H]
	\centerline{\includegraphics[scale=0.5]{zed_net_bias}}
	\caption{Successful Network Mode Execution}
	\label{fig:netBias}
\end{figure}

\begin{minipage}{\linewidth}
To view the input file, run the following command: ``\code{hexdump test.input | less}'' and the file should look like Figure~\ref{fig:inBias1}: \\ \medskip
\begin{figure}[H]
	\centerline{\includegraphics[scale=0.5]{zed_bias_input}}
	\caption{Expected Input}
	\label{fig:inBias1}
\end{figure}
\end{minipage}
~\\
\begin{minipage}{\linewidth}
To view the output file, run the following command: ``\code{hexdump test.output | less}'' and the file should look like Figure~\ref{fig:outBias1}: \\
\begin{figure}[H]
	\centerline{\includegraphics[scale=0.5]{zed_bias_output}}
	\caption{Expected Output}
	\label{fig:outBias1}
\end{figure}
\end{minipage}
~\\
\newpage
\subsection{Running Standalone Mode}
\begin{flushleft}
The default setup script should already set the \texttt{OCPI\_LIBRARY\_PATH} variable to all the required locations for the framework to execute the application.  All three of the artifacts that are located on the SD card are mounted at \texttt{/mnt/card/opencpi/artifacts}.  After running \texttt{mysetup.sh}, navigate to \texttt{/mnt/card/opencpi/xml}.  In order to run the application, use the following command: ``\texttt{ocpirun -v -t 1 -d -m bias=hdl bias.xml}'' The output should be as follows:
\end{flushleft}
\begin{figure}[H]
	\centerline{\includegraphics[scale=0.5]{zed_bias}}
	\caption{Successful Standalone Mode Execution}
 \label{fig:standBias}
\end{figure}

\begin{minipage}{\linewidth}
To view the input file, run the following command: ``\code{hexdump test.input | less}'' and the file should look like Figure~\ref{fig:inBias2}: \\ \medskip
\begin{figure}[H]
	\centerline{\includegraphics[scale=0.5]{zed_bias_input}}
	\caption{Expected Input}
	\label{fig:inBias2}
\end{figure}
\end{minipage}
~\\
\begin{minipage}{\linewidth}
To view the output file, run the following command: ``\code{hexdump test.output | less}'' and the file should look like Figure~\ref{fig:outBias2}: \\
\begin{figure}[H]
	\centerline{\includegraphics[scale=0.5]{zed_bias_output}}
	\caption{Expected Output}
	\label{fig:outBias2}
\end{figure}
\end{minipage}
~\\

\begin{appendices}
\section{Using ISE instead of Vivado with the ZedBoard}
It is recommended that you use the default toolset (Xilinx Vivado) to build ZedBoard bitstreams with ANGRYVIPER. However, if you wish to use ISE instead, you can use the \code{zed\_ise} platform and \code{zynq\_ise} target. So, instead of ``\code{ocpidev build -\--hdl-platform zed}'', run ``\code{ocpidev build -\--hdl-platform zed\_ise}''. Instead of ``\code{ocpidev build hdl platform zed}'', run ``\code{ocpidev build hdl platform zed\_ise}''.  Instead of ``\code{ocpidev build hdl assembly testbias -\--hdl-platform zed}'', run ``\code{ocpidev build hdl assembly testbias -\--hdl-platform zed\_ise}''. Additionally, you will have to copy the \code{system.xml} file located in \path{<Assets_Project>/hdl/platforms/zed_ise/sd_card/} to the \code{opencpi} directory of the SD card.
% Bring in kernel message snippet
\input{snippets/Driver_Snippet.tex}
%
\end{appendices}
\end{document}
